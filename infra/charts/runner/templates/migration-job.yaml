apiVersion: batch/v1
kind: Job
metadata:
    name: {{ include "runner.fullname" . }}-migration
    labels:
        {{- include "runner.labels" . | nindent 4 }}
    annotations:
        "helm.sh/hook": post-install, post-upgrade
        "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
        "helm.sh/hook-weight": "0"
spec:
    template:
        metadata:
            name: {{ include "runner.fullname" . }}-migration
        spec:
            restartPolicy: Never
            initContainers:
                - name: wait-for-db
                  image: postgres:15-alpine
                  command: ['sh', '-c', 'until pg_isready -h $DB_HOST -p $DB_PORT -U $DB_USER; do echo waiting for database; sleep 2; done;']
                  env:
                    - name: DB_HOST
                      value: {{ .Release.Name }}-postgresql
                    - name: DB_PORT
                      value: "5432"
                    - name: DB_USER
                      value: {{ .Values.postgres.auth.username }}
            containers:
                - name: db-migration
                  image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
                  imagePullPolicy: {{ .Values.image.pullPolicy }}
                  command: ["python", "app/manage.py", "migrate", "--noinput"]
                  env:
                    - name: DJANGO_SECRET_KEY
                      value: {{ .Values.env.djangoSecretKey | default "unsafe-dev-key" }}
                    - name: DB_ENGINE
                      value: "django.db.backends.postgresql"
                    - name: DB_HOST
                      value: {{ .Release.Name }}-postgresql
                    - name: DB_PORT
                      value: "5432"
                    - name: DB_NAME
                      value: {{ .Values.postgres.auth.database }}
                    - name: DB_USER
                      value: {{ .Values.postgres.auth.username }}
                    - name: DB_PASSWORD
                      value: {{ .Values.postgres.auth.password }}
