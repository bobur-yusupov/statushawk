name: API Gateway testing

on:
    push:
        paths:
            - "services/api-gateway/**"
    pull_request:
        paths:
            - "services/api-gateway/**"

jobs:
    lint:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
            
            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                python-version: '3.12'
            - name: Install Poetry
              uses: snok/install-poetry@v1 
              with:
                version: 2.2.1

            - name: Install dependencies and configure environment
              run: |
                cd services/api-gateway
                poetry install --no-root --no-interaction

            - name: Run linter
              run: |
                cd services/api-gateway &&
                poetry run flake8 .
    
    test:
        runs-on: ubuntu-latest
        needs: lint
        steps:
            - uses: actions/checkout@v4

            - name: Setup python
              uses: actions/setup-python@v5
              with:
                python-version: '3.12'
            
            - name: Docker Compose Build
              run: |
                cd services/ &&
                docker compose -f docker-compose.test.yaml build
            - name: Run Tests
              run: |
                cd services/ &&
                ./test.sh api-gateway
    
    version:
      runs-on: ubuntu-latest
      needs: test
      if: github.ref == 'refs/heads/main' && github.event_name == 'push' 
      permissions:
            contents: write
      
      steps:
            - uses: actions/checkout@v4
              with:
                fetch-depth: 0 # Get full history for semantic parsing
                
            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                python-version: '3.12'
            - name: Install Poetry
              uses: snok/install-poetry@v1 
              with:
                version: 2.2.1

            - name: Install dependencies and configure environment
              run: |
                cd services/api-gateway
                poetry install --no-root --no-interaction

            - name: Determine & Bump Version
              run: |
                cd services/api-gateway
                
                # Logic to determine bump type (Major, Minor, or Patch) based on last commit
                COMMIT_MESSAGE=$(git log -1 --pretty=%B)
                
                if echo "$COMMIT_MESSAGE" | grep -q "BREAKING CHANGE"; then
                    CHANGE_TYPE="major"
                elif echo "$COMMIT_MESSAGE" | grep -q "^feat"; then
                    CHANGE_TYPE="minor"
                elif echo "$COMMIT_MESSAGE" | grep -q "^fix"; then
                    CHANGE_TYPE="patch"
                else
                    echo "No semantic change detected. Exiting version job."
                    exit 0 # Exit successfully if no bump is needed
                fi
                
                # Bump the version in pyproject.toml and poetry.lock
                poetry version $CHANGE_TYPE
                NEW_VERSION=$(poetry version --short)
                
                echo "Bumping to v$NEW_VERSION based on $CHANGE_TYPE change."
                
                # Configure git and commit the changes
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                
                git add pyproject.toml poetry.lock
                # [skip ci] prevents the push from triggering the entire workflow in an infinite loop
                git commit -m "ci: bump version to $NEW_VERSION [skip ci]"
                git push

    build-and-push:
        runs-on: ubuntu-latest
        needs: version
        steps:
            - uses: actions/checkout@v4
              with:
                ref: main 
                fetch-depth: 0

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_TOKEN }}

            - name: Setup Poetry (Required for versioning in subsequent steps)
              uses: snok/install-poetry@v1 
              with:
                version: 2.2.1
            
            - name: Build, Tag, and Push Image
              run: |
                cd services &&
                ./build-and-push.sh api-gateway
